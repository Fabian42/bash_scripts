#!/bin/bash
source /home/fabian/hdd/d/programs/bash_scripts/sane
# TODO: handle stdin
# TODO: remove variables and function from .bashrc
wl_id=$(cat /home/fabian/hdd/d/programs/bash_scripts/wl_id.txt)
tm_id=$(cat /home/fabian/hdd/d/programs/bash_scripts/tm_id.txt)
yt_pw=$(cat /home/fabian/hdd/d/programs/bash_scripts/yt_pw.txt)

if [[ "$1" =~ ^(\-\-?|\/)?(h(elp)?|\?)$ && "$2" == "" ]]; then
 wrap "WARNING: This script is currently getting refactored. This help text is ahead of development."
 wrap "Downloads something using youtube-dlp."
 echo "Usage:"
 tablewrap "dl [-[-]|/](h[elp]|?)" "Shows this help."\
           "dl [m|n|N|r|\e[3mINDEX\e[0m]…" "Downloads WL into Downloads or, with \"m\", temp_music into t."\
           "dl [f|m|n|N|r]… (\e[3mFILE\e[0m|\e[3mURL\e[0m [f|m|n|N|r|\e[3mINDEX\e[0m]…)…" "Downloads all \e[3mURL\e[0ms listed as arguments or in \e[3mFILE\e[0ms with yt-dlp."
 echo
 wrap "Context-specific options:"
 wrap "f: Create subfolders and download into them."
 wrap "n: Number entries. Enabled by default for playlists."
 wrap "These apply to the level where they are specified, for example \"dl n fileA fileB\" prepends all video filenames that come from fileA with \"0001_\" and all filenames from fileB with \"0002_\". \"dl fileA n fileB\" prepends the video from the first line of fileA with \"0001_\", the video from the second line of fileA with \"0002_\" and the videos from fileB with nothing. \"dl f plA plB\" creates two folders, named after the playlists behind plA and plB, and the video files will be put into those respective folders. \"dl fileA f\" creates one folder per line in fileA."
 echo
 wrap "General options:"
 wrap "m: Download as audio only and convert to MP3."
 wrap "r: Limit resolution to 1080p. Set by default. If both \"m\" and \"r\" are specified, \"m\" takes precedence."
 wrap "These apply to everything on their level and below. For example \"dl m urlA urlB\" downloads urlA and urlB as music, \"dl urlA m urlB\" downloads urlA as music and urlB as video. A file can override the download command for any line."
 wrap "Capital M and R disable their lowercase versions. This is especially useful for R, because it always has to be specified to download videos with a resolution of >1080p. For example \"dl m urlA urlB M\" downloads urlA as music and urlB as video."
 wrap "\"N\" is the opposite of \"n\" and overrides it if both are present. This is most useful to not number playlist entries, but can also be used to manually override an \"n\" in e.g. a Bash alias."
 wrap "The arguments \"f\", \"m\", \"n\", \"N\" and \"r\" do not require spaces between them, so e.g. \"nfm\" is possible."
 echo
 wrap "One number can be specified as a start index, a second one as an end index. Those indices are line numbers if the entry is a file and a playlist index if it is an URL. A third and further numbers do nothing."
 wrap "Each line in a \e[3mFILE\e[0m works just like another \"dl\" command, so for example an empty line downloads WL. But the usual usecase is just a list of links. Lines starting with a usual comment indicator are skipped. Run \"dl --comments\" for a full list."
 wrap "Do specify a file named \"m\", \"n\" or \"r\", use a path: \"./m\""
 wrap "Behaviour summary: \e[3mFILE\e[0ms get expanded until only \e[3mURL\e[0ms are left, \"m\" and \"r\" get passed along, \"n\" gets applied only in the current command."
 wrap "The script tries to be smart. For example all folders in \$CDPATH are searched and IDs instead of full URLs often work."
 echo
 wrap "English, German and Japanese non-automatic subtitles are included in video downloads."
 wrap "yt-dlp and FFMPEG are both set to silent except for the progress indicator, in the ideal case the only output left at the end are success messages from the script. Errors and some warnings will still appear."
 echo
 wrap "Examples:"
 tablewrap "dl" "Downloads the entire WL playlist into ~/Downloads. Already downloaded tracks are skipped, as usual."\
           "dl m 4" "Downloads the temp_music playlist as MP3 into t, skipping the first three tracks."\
           "dl https://www.youtube.com/watch?v=lXMskKTw3Bc" "Downloads that video."\
           "dl r list.txt 2 4 \"enL2Z05WhTU\" m '_qJHEPecdvg'" "Downloads videos from lines 2, 3 and 4 of file \"list.txt\" and the YouTube video with the ID \"_qJHEPecdvg\" at maximum resolution and the YouTube video with the ID \"_qJHEPecdvg\" as MP3."\
           "dl LL 42 m 69 3141 k3RKPyJPMOY r" "Downloads videos 42 to 69 from the liked videos playlist as MP3 and then the video with the ID \"k3RKPyJPMOY\" in maximum resolution."
 echo
 wrap "Current contents of ~/.config/yt-dlp/config:"
 cat ~/.config/yt-dlp/config
 exit
elif [[ "$1" == "--comments" ]]; then
 wrap "All lines in a given file are skipped that begin with any amount (including none) of whitespace and then one of these:"
 echo "#"
 echo "/"
 echo "\\"
 echo "*"
 echo ";"
 echo "%"
 echo "\!"
 echo "|"
 echo "("
 echo "{"
 echo "="
 echo "¢"
 echo "£"
 echo "⍝"
 echo "::"
 echo "<#"
 echo "\$\!"
 echo "\$\$"
 echo "{-"
 echo "@c"
 echo "@C"
 echo "R:"
 echo "r:"
 echo "NB."
 echo "Nb."
 echo "nB."
 echo "nb."
 echo "\'\'\'"
 echo "\"\"\""
 echo "\<\!--"
 echo "--[["
 echo "--[="
 wrap "Multi-line comments are not supported (prefixes like /* still just apply to that one line). Closing of e.g. HTML comments is not necessary."
 wrap "Comments starting with REM, -- and a few others are not supported because YouTube IDs could start with those. Comments starting with \" or ' are not supported because they can be used to prevent word splitting."
 exit
fi

### MAIN PART START
# print start time only for initial call in recursion
if [[ "$dl_time_printed" == "" ]]; then date "+%H:%M:%S"; export dl_time_printed=1; fi
# preparation for later looking up files in all CDPATH locations
if [[ "$CDPATH" == "" ]]; then CDPATH="."; fi
t